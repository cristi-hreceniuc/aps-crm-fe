<%- include('partials/head', { title: 'AplicaÈ›ie LogopedicÄƒ' }) %>
<div class="app">
  <%- include('partials/sidenav', { path, isLogged, user }) %>

  <main class="content-shell">
    <header class="content-header">
      <div>
        <h1>AplicaÈ›ie LogopedicÄƒ</h1>
        <small class="muted">Administrare</small>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="grid-users">Utilizatori</button>
      <button class="tab-btn" data-tab="grid-notifications">NotificÄƒri</button>
    </div>

    <!-- Grid 1: Utilizatori -->
    <section id="grid-users" class="tab-pane active">
      <%- include('partials/datagrid', {
        gridId: 'log-users',
        title: 'Utilizatori',
        subtitle: 'Gestionare conturi logopedie',
        searchPlaceholder: 'CautÄƒ dupÄƒ nume, email sau telefonâ€¦',
        endpoint: '/api/logopedie/users',         // list/search unificat
        endpointSearch: '/api/logopedie/users',   // datagrid trimite ?q=
        pageSize: 10,
        api: { pageParam:'page', sizeParam:'size', sortParam:'sort', sortValue:'{key},{dir}', pageBase:0, searchParam:'q' },
        response: { items:'content', page:'number', size:'size', total:'totalElements' },
        columns: [
          { key:'firstName',        label:'Nume',          sortable:true, sortKey:'firstName' },
          { key:'lastName',      label:'Prenume',        sortable:true, sortKey:'lastName' },
          { key:'email',     label:'Email',       sortable:true, sortKey:'email', clamp:1 },
          { key:'createdAt', label:'Creat la',    sortable:true, sortKey:'createdAt', type:'date' },
          { key:'updatedAt', label:'Actualizat la',    sortable:true, sortKey:'updatedAt', type:'date' },
          { key:'gender', label:'Gen',    sortable:true, sortKey:'gender' },
          { key:'status',    label:'Status',      sortable:true, sortKey:'status' },
          { key:'role',    label:'Rol',      sortable:true, sortKey:'role' },
          { key:'isPremium', label:'Premium',     sortable:true, sortKey:'isPremium', type:'bool' },
          { key:'actions',   label:'AcÈ›iuni',     type:'actions' }
        ],
        autosize: { minPx: 90, maxPx: 320 }
      }) %>

      <!-- Settings Card (Admin Only) -->
      <% if (user && user.userRole === 'ADMIN') { %>
      <div class="card" style="margin-top: 2rem;">
        <h2 style="margin-bottom: 0.5rem;">SetÄƒri Autentificare</h2>
        <p class="muted" style="margin-bottom: 1rem;">ControleazÄƒ restricÈ›iile de autentificare pentru aplicaÈ›ia mobilÄƒ</p>
        
        <label class="auth-toggle" style="margin-top: 12px; display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
          <input type="checkbox" id="require-active-toggle">
          <span class="slider"></span>
          <span id="toggle-label">Permite autentificare doar pentru conturi ACTIVE</span>
        </label>
        <small class="muted" style="display: block; margin-top: 0.5rem; margin-left: 3rem;">
          <span id="toggle-description">CÃ¢nd este activatÄƒ, doar conturile cu status ACTIVE pot sÄƒ se autentifice Ã®n aplicaÈ›ia mobilÄƒ.</span>
        </small>
        <div id="setting-status" style="margin-top: 0.75rem; margin-left: 3rem; display: none;"></div>
      </div>
      <% } %>
    </section>

    <!-- Tab 2: NotificÄƒri -->
    <section id="grid-notifications" class="tab-pane">
      <div class="card" style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
        <h2 style="margin-bottom: 0.5rem;">ğŸ“¢ Trimite Notificare</h2>
        <p class="muted" style="margin-bottom: 1.5rem;">Trimite notificÄƒri push cÄƒtre utilizatorii aplicaÈ›iei mobile</p>
        
        <form id="notification-form">
          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="notif-target" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Destinatari</label>
            <select id="notif-target" name="target" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
              <option value="all">ToÈ›i utilizatorii</option>
              <option value="premium">Doar Premium</option>
              <option value="non_premium">Doar Non-Premium</option>
              <option value="role">DupÄƒ Rol</option>
            </select>
          </div>

          <div id="role-options" style="display: none; margin-bottom: 1rem;">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="notif-role" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rol</label>
              <select id="notif-role" name="role" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
                <option value="USER">Utilizator (USER)</option>
                <option value="SPECIALIST">Specialist (SPECIALIST)</option>
                <option value="ADMIN">Administrator (ADMIN)</option>
                <option value="VOLUNTEER">Voluntar (VOLUNTEER)</option>
              </select>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="filter-premium" name="filterPremium">
                <span>FiltreazÄƒ È™i dupÄƒ status premium</span>
              </label>
            </div>
            <div id="premium-filter" style="display: none; margin-top: 0.5rem; margin-left: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="isPremium" value="true"> Premium
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.25rem;">
                <input type="radio" name="isPremium" value="false" checked> Non-Premium
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="notif-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Titlu</label>
            <input type="text" id="notif-title" name="title" required maxlength="100"
                   placeholder="Ex: NoutÄƒÈ›i Ã®n aplicaÈ›ie! ğŸ‰"
                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="notif-body" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mesaj</label>
            <textarea id="notif-body" name="body" required rows="4" maxlength="500"
                      placeholder="Mesajul notificÄƒrii..."
                      style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
            <small class="muted" style="display: block; margin-top: 0.25rem;"><span id="char-count">0</span>/500 caractere</small>
          </div>

          <div id="notification-result" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>

          <button type="submit" id="send-btn" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
            <span id="btn-text">ğŸ“¤ Trimite Notificare</span>
            <span id="btn-loading" style="display: none;">â³ Se trimite...</span>
          </button>
        </form>
      </div>
    </section>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tab switching (same pattern as cauze.ejs)
  const tabs = document.querySelectorAll('.tab-btn');
  const panes = document.querySelectorAll('.tab-pane');

  const savedTab = localStorage.getItem('logopedie-active-tab') || 'grid-users';

  function activateTab(tabId) {
    tabs.forEach(x => x.classList.remove('active'));
    panes.forEach(x => x.classList.remove('active'));

    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    const pane = document.getElementById(tabId);

    if (btn && pane) {
      btn.classList.add('active');
      pane.classList.add('active');
      localStorage.setItem('logopedie-active-tab', tabId);
      window.dispatchEvent(new Event('resize'));
    }
  }

  activateTab(savedTab);

  tabs.forEach(b => {
    b.addEventListener('click', () => {
      activateTab(b.dataset.tab);
    });
  });

  // Notification form handling
  const targetSelect = document.getElementById('notif-target');
  const roleOptions = document.getElementById('role-options');
  const filterPremiumCheckbox = document.getElementById('filter-premium');
  const premiumFilter = document.getElementById('premium-filter');
  const bodyTextarea = document.getElementById('notif-body');
  const charCount = document.getElementById('char-count');
  const form = document.getElementById('notification-form');
  const resultDiv = document.getElementById('notification-result');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const sendBtn = document.getElementById('send-btn');

  // Show/hide role options based on target selection
  targetSelect.addEventListener('change', () => {
    roleOptions.style.display = targetSelect.value === 'role' ? 'block' : 'none';
  });

  // Show/hide premium filter
  filterPremiumCheckbox.addEventListener('change', () => {
    premiumFilter.style.display = filterPremiumCheckbox.checked ? 'block' : 'none';
  });

  // Character counter
  bodyTextarea.addEventListener('input', () => {
    charCount.textContent = bodyTextarea.value.length;
  });

  // Load and handle require_active_for_login setting (admin only)
  <% if (user && user.userRole === 'ADMIN') { %>
  const requireActiveToggle = document.getElementById('require-active-toggle');
  const toggleLabel = document.getElementById('toggle-label');
  const toggleDescription = document.getElementById('toggle-description');
  const settingStatus = document.getElementById('setting-status');

  // Load current setting
  async function loadRequireActiveSetting() {
    try {
      const res = await fetch('/api/logopedie/require-active-for-login', {
        credentials: 'same-origin'
      });
      if (res.ok) {
        const data = await res.json();
        requireActiveToggle.checked = data.requireActiveForLogin || false;
        updateToggleLabel();
      }
    } catch (err) {
      console.error('Error loading setting:', err);
    }
  }

  function updateToggleLabel() {
    if (requireActiveToggle.checked) {
      toggleLabel.textContent = 'Permite autentificare doar pentru conturi ACTIVE';
      toggleDescription.textContent = 'CÃ¢nd este activatÄƒ, doar conturile cu status ACTIVE pot sÄƒ se autentifice Ã®n aplicaÈ›ia mobilÄƒ.';
    } else {
      toggleLabel.textContent = 'Permite autentificare pentru toate conturile';
      toggleDescription.textContent = 'CÃ¢nd este dezactivatÄƒ, toate conturile (ACTIVE, PENDING, INACTIVE) pot sÄƒ se autentifice Ã®n aplicaÈ›ia mobilÄƒ.';
    }
  }

  // Save setting on toggle
  requireActiveToggle.addEventListener('change', async () => {
    const isChecked = requireActiveToggle.checked;
    settingStatus.style.display = 'block';
    settingStatus.style.background = 'var(--info-bg, #d1ecf1)';
    settingStatus.style.color = 'var(--info-text, #0c5460)';
    settingStatus.style.padding = '0.5rem';
    settingStatus.style.borderRadius = '4px';
    settingStatus.textContent = 'â³ Se salveazÄƒ...';
    requireActiveToggle.disabled = true;

    try {
      const res = await fetch('/api/logopedie/require-active-for-login', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ requireActiveForLogin: isChecked })
      });

      if (res.ok) {
        settingStatus.style.background = 'var(--success-bg, #d4edda)';
        settingStatus.style.color = 'var(--success-text, #155724)';
        settingStatus.textContent = 'âœ… Setare salvatÄƒ cu succes!';
        updateToggleLabel();
        setTimeout(() => {
          settingStatus.style.display = 'none';
        }, 3000);
      } else {
        const data = await res.json();
        settingStatus.style.background = 'var(--danger-bg, #f8d7da)';
        settingStatus.style.color = 'var(--danger-text, #721c24)';
        settingStatus.textContent = `âŒ Eroare: ${data.message || 'Nu s-a putut salva setarea'}`;
        requireActiveToggle.checked = !isChecked; // Revert on error
      }
    } catch (err) {
      settingStatus.style.background = 'var(--danger-bg, #f8d7da)';
      settingStatus.style.color = 'var(--danger-text, #721c24)';
      settingStatus.textContent = `âŒ Eroare de conexiune: ${err.message}`;
      requireActiveToggle.checked = !isChecked; // Revert on error
    } finally {
      requireActiveToggle.disabled = false;
    }
  });

  // Load setting on page load
  loadRequireActiveSetting();
  <% } %>

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const target = formData.get('target');
    const title = formData.get('title');
    const body = formData.get('body');
    
    const payload = { title, body, target };
    
    if (target === 'role') {
      payload.role = formData.get('role');
      if (filterPremiumCheckbox.checked) {
        payload.isPremium = formData.get('isPremium') === 'true';
      }
    }

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    sendBtn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const response = await fetch('/api/logopedie/notifications/targeted', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      
      resultDiv.style.display = 'block';
      if (response.ok && data.success) {
        resultDiv.style.background = 'var(--success-bg, #d4edda)';
        resultDiv.style.color = 'var(--success-text, #155724)';
        resultDiv.innerHTML = `âœ… ${data.message}`;
        form.reset();
        charCount.textContent = '0';
        roleOptions.style.display = 'none';
        premiumFilter.style.display = 'none';
      } else {
        resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
        resultDiv.style.color = 'var(--danger-text, #721c24)';
        resultDiv.innerHTML = `âŒ ${data.message || 'Eroare la trimitere'}`;
      }
    } catch (err) {
      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
      resultDiv.style.color = 'var(--danger-text, #721c24)';
      resultDiv.innerHTML = `âŒ Eroare de conexiune: ${err.message}`;
    } finally {
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      sendBtn.disabled = false;
    }
  });
});
</script>

<%- include('partials/footer') %>
