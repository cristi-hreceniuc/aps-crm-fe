<%- include('partials/head', { title: 'AplicaÈ›ie LogopedicÄƒ' }) %>
<div class="app">
  <%- include('partials/sidenav', { path, isLogged, user }) %>

  <main class="content-shell">
    <header class="content-header">
      <div>
        <h1>AplicaÈ›ie LogopedicÄƒ</h1>
        <small class="muted">Administrare</small>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="grid-users">Utilizatori</button>
      <button class="tab-btn" data-tab="grid-bundles">Bundle SpecialiÈ™ti</button>
      <button class="tab-btn" data-tab="grid-notifications">NotificÄƒri</button>
    </div>

    <!-- Grid 1: Utilizatori -->
    <section id="grid-users" class="tab-pane active">
      <%- include('partials/datagrid', {
        gridId: 'log-users',
        title: 'Utilizatori',
        subtitle: 'Gestionare conturi logopedie',
        searchPlaceholder: 'CautÄƒ dupÄƒ nume, email sau telefonâ€¦',
        endpoint: '/api/logopedie/users',         // list/search unificat
        endpointSearch: '/api/logopedie/users',   // datagrid trimite ?q=
        pageSize: 10,
        api: { pageParam:'page', sizeParam:'size', sortParam:'sort', sortValue:'{key},{dir}', pageBase:0, searchParam:'q' },
        response: { items:'content', page:'number', size:'size', total:'totalElements' },
        columns: [
          { key:'firstName',        label:'Nume',          sortable:true, sortKey:'firstName' },
          { key:'lastName',      label:'Prenume',        sortable:true, sortKey:'lastName' },
          { key:'email',     label:'Email',       sortable:true, sortKey:'email', clamp:1 },
          { key:'createdAt', label:'Creat la',    sortable:true, sortKey:'createdAt', type:'date' },
          { key:'updatedAt', label:'Actualizat la',    sortable:true, sortKey:'updatedAt', type:'date' },
          { key:'gender', label:'Gen',    sortable:true, sortKey:'gender' },
          { key:'status',    label:'Status',      sortable:true, sortKey:'status' },
          { key:'role',    label:'Rol',      sortable:true, sortKey:'role' },
          { key:'isPremium', label:'Premium',     sortable:true, sortKey:'isPremium', type:'bool' },
          { key:'actions',   label:'AcÈ›iuni',     type:'actions' }
        ],
        autosize: { minPx: 90, maxPx: 320 }
      }) %>

      <!-- Settings Card (Admin Only) -->
      <% if (user && user.userRole === 'ADMIN') { %>
      <div class="card" style="margin-top: 2rem;">
        <h2 style="margin-bottom: 0.5rem;">SetÄƒri Autentificare</h2>
        <p class="muted" style="margin-bottom: 1rem;">ControleazÄƒ restricÈ›iile de autentificare pentru aplicaÈ›ia mobilÄƒ</p>
        
        <label class="auth-toggle" style="margin-top: 12px; display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
          <input type="checkbox" id="require-active-toggle">
          <span class="slider"></span>
          <span id="toggle-label">Permite autentificare doar pentru conturi ACTIVE</span>
        </label>
        <small class="muted" style="display: block; margin-top: 0.5rem; margin-left: 3rem;">
          <span id="toggle-description">CÃ¢nd este activatÄƒ, doar conturile cu status ACTIVE pot sÄƒ se autentifice Ã®n aplicaÈ›ia mobilÄƒ.</span>
        </small>
        <div id="setting-status" style="margin-top: 0.75rem; margin-left: 3rem; display: none;"></div>
      </div>
      <% } %>
    </section>

    <!-- Tab 2: Bundle SpecialiÈ™ti -->
    <section id="grid-bundles" class="tab-pane">
      <div class="card" style="margin-bottom: 2rem;">
        <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.5rem; height: 1.5rem; color: var(--primary, #dc2626);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
          </svg>
          Administrare Bundle-uri
        </h2>
        <p class="muted" style="margin-bottom: 1.5rem;">
          Aici poÈ›i vedea È™i administra specialiÈ™tii care au primit bundle-uri cu chei de licenÈ›Äƒ pentru copii.
        </p>
        
        <!-- Bundle List Table -->
        <div id="bundles-container">
          <div class="bundle-loading" style="text-align: center; padding: 2rem;">
            <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 2rem; height: 2rem; animation: spin 1s linear infinite; color: var(--text-muted);">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="muted">Se Ã®ncarcÄƒ bundle-urile...</p>
          </div>
        </div>

        <!-- Assign Bundle Form (Modal) -->
        <div id="assign-bundle-modal" class="modal" style="display: none;">
          <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
              <h3>AdaugÄƒ Bundle</h3>
              <button type="button" class="modal-close" onclick="closeAssignBundleModal()">&times;</button>
            </div>
            <div class="modal-body">
              <form id="assign-bundle-form">
                <div class="form-group" style="margin-bottom: 1rem;">
                  <label for="bundle-specialist-search" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">CautÄƒ Specialist</label>
                  <input type="text" id="bundle-specialist-search" placeholder="CautÄƒ dupÄƒ nume sau email..."
                         style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
                  <input type="hidden" id="bundle-specialist-id" name="specialistId">
                  <div id="specialist-search-results" style="margin-top: 0.5rem; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; display: none;"></div>
                  <div id="selected-specialist" style="margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-muted, #f3f4f6); border-radius: 6px; display: none;">
                    <span id="selected-specialist-name"></span>
                    <button type="button" onclick="clearSelectedSpecialist()" style="float: right; background: none; border: none; cursor: pointer; color: var(--danger, #dc2626);">&times;</button>
                  </div>
                </div>

                <div class="form-group" style="margin-bottom: 1rem; position: relative;">
                  <label for="bundle-key-count" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">NumÄƒr de Chei</label>
                  <select id="bundle-key-count" name="keyCount" required
                          style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; appearance: none; background-color: var(--bg, #fff);">
                    <option value="5">5 chei</option>
                    <option value="10">10 chei</option>
                    <option value="15">15 chei</option>
                    <option value="25">25 chei</option>
                  </select>
                  <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.125rem; height: 1.125rem; position: absolute; right: 0.75rem; top: 2.5rem; pointer-events: none; color: var(--text-muted);">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                  <label for="bundle-notes" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Note (opÈ›ional)</label>
                  <textarea id="bundle-notes" name="notes" rows="3" placeholder="Note despre acest bundle..."
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
                </div>

                <div id="assign-bundle-result" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>

                <div style="display: flex; gap: 1rem;">
                  <button type="button" class="btn btn-secondary" onclick="closeAssignBundleModal()" style="flex: 1;">AnuleazÄƒ</button>
                  <button type="submit" id="assign-bundle-btn" class="btn btn-primary" style="flex: 1;" disabled>AdaugÄƒ Bundle</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Bundle Detail Modal -->
        <div id="bundle-detail-modal" class="modal" style="display: none;">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3>Detalii Bundle</h3>
              <button type="button" class="modal-close" onclick="closeBundleDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div id="bundle-detail-content">
                <!-- Content filled by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Bundle Button -->
      <button type="button" class="btn btn-primary" onclick="openAssignBundleModal()" style="display: flex; align-items: center; gap: 0.5rem;">
        <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        AdaugÄƒ Bundle
      </button>
    </section>

    <!-- Tab 3: NotificÄƒri -->
    <section id="grid-notifications" class="tab-pane">
      <div class="card" style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
        <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.5rem; height: 1.5rem; color: var(--primary, #dc2626);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 110-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 01-1.44-4.282m3.102.069a18.03 18.03 0 01-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 018.835 2.535M10.34 6.66a23.847 23.847 0 008.835-2.535m0 0A23.74 23.74 0 0018.795 3m.38 1.125a23.91 23.91 0 011.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 001.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a23.91 23.91 0 010 3.46" />
          </svg>
          Trimite Notificare
        </h2>
        <p class="muted" style="margin-bottom: 1.5rem;">Trimite notificÄƒri push cÄƒtre utilizatorii aplicaÈ›iei mobile</p>
        
        <form id="notification-form">
          <div class="form-group" style="margin-bottom: 1rem; position: relative;">
            <label for="notif-target" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Destinatari</label>
            <select id="notif-target" name="target" required style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; appearance: none; background-color: var(--bg, #fff);">
              <option value="all">ToÈ›i utilizatorii</option>
              <option value="user_normal">ToÈ›i utilizatorii normali</option>
              <option value="user_premium">ToÈ›i utilizatorii premium</option>
              <option value="specialist_all">ToÈ›i specialiÈ™tii</option>
              <option value="specialist_normal">ToÈ›i specialiÈ™tii normali</option>
              <option value="specialist_premium">ToÈ›i specialiÈ™tii premium</option>
            </select>
            <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; position: absolute; right: 0.75rem; top: 2.5rem; pointer-events: none; color: var(--text-muted, #6b7280);">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </div>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="notif-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Titlu</label>
            <input type="text" id="notif-title" name="title" required maxlength="100"
                   placeholder="Ex: NoutÄƒÈ›i Ã®n aplicaÈ›ie! ðŸŽ‰"
                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="notif-body" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mesaj</label>
            <textarea id="notif-body" name="body" required rows="4" maxlength="500"
                      placeholder="Mesajul notificÄƒrii..."
                      style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
            <small class="muted" style="display: block; margin-top: 0.25rem;"><span id="char-count">0</span>/500 caractere</small>
          </div>

          <div id="notification-result" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>

          <button type="submit" id="send-btn" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <span id="btn-text" style="display: flex; align-items: center; gap: 0.5rem;">
              <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
              </svg>
              Trimite Notificare
            </span>
            <span id="btn-loading" style="display: none; align-items: center; gap: 0.5rem;">
              <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; animation: spin 1s linear infinite;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Se trimite...
            </span>
          </button>
        </form>
      </div>
    </section>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tab switching (same pattern as cauze.ejs)
  const tabs = document.querySelectorAll('.tab-btn');
  const panes = document.querySelectorAll('.tab-pane');

  const savedTab = localStorage.getItem('logopedie-active-tab') || 'grid-users';

  function activateTab(tabId) {
    tabs.forEach(x => x.classList.remove('active'));
    panes.forEach(x => x.classList.remove('active'));

    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    const pane = document.getElementById(tabId);

    if (btn && pane) {
      btn.classList.add('active');
      pane.classList.add('active');
      localStorage.setItem('logopedie-active-tab', tabId);
      window.dispatchEvent(new Event('resize'));
      
      // Load bundles when switching to that tab
      if (tabId === 'grid-bundles') {
        loadBundles();
      }
    }
  }

  activateTab(savedTab);

  tabs.forEach(b => {
    b.addEventListener('click', () => {
      activateTab(b.dataset.tab);
    });
  });

  // ============== BUNDLE MANAGEMENT ==============
  
  let bundleData = [];
  let searchTimeout = null;

  // Load bundles
  async function loadBundles() {
    const container = document.getElementById('bundles-container');
    container.innerHTML = `
      <div class="bundle-loading" style="text-align: center; padding: 2rem;">
        <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 2rem; height: 2rem; animation: spin 1s linear infinite; color: var(--text-muted);">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="muted">Se Ã®ncarcÄƒ bundle-urile...</p>
      </div>
    `;

    try {
      const res = await fetch('/api/logopedie/bundles', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load bundles');
      bundleData = await res.json();
      renderBundlesTable();
    } catch (err) {
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--danger, #dc2626);">
          <p>Eroare la Ã®ncÄƒrcarea bundle-urilor: ${err.message}</p>
          <button class="btn btn-secondary" onclick="loadBundles()" style="margin-top: 1rem;">ReÃ®ncearcÄƒ</button>
        </div>
      `;
    }
  }

  function renderBundlesTable() {
    const container = document.getElementById('bundles-container');
    
    if (bundleData.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
          <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 3rem; height: 3rem; margin-bottom: 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
          </svg>
          <p>Nu existÄƒ bundle-uri. FoloseÈ™te butonul "AdaugÄƒ Bundle" pentru a crea unul.</p>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div style="overflow-x: auto;">
        <table class="data-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--bg-muted, #f3f4f6);">
              <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Specialist</th>
              <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Email</th>
              <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--border);">Chei</th>
              <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--border);">Premium</th>
              <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Data AlocÄƒrii</th>
              <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--border);">AcÈ›iuni</th>
            </tr>
          </thead>
          <tbody>
            ${bundleData.map(b => `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.75rem;">${escapeHtml(b.specialistName)}</td>
                <td style="padding: 0.75rem;">${escapeHtml(b.specialistEmail)}</td>
                <td style="padding: 0.75rem; text-align: center;">${b.usedKeys}/${b.totalKeys}</td>
                <td style="padding: 0.75rem; text-align: center;">
                  <label class="toggle-switch" style="cursor: pointer;">
                    <input type="checkbox" ${b.isPremium ? 'checked' : ''} onchange="toggleBundlePremium('${b.specialistId}', this.checked)">
                    <span class="slider round"></span>
                  </label>
                </td>
                <td style="padding: 0.75rem;">${formatDate(b.assignedAt)}</td>
                <td style="padding: 0.75rem; text-align: center;">
                  <button class="btn btn-sm btn-secondary" onclick="viewBundleDetail('${b.specialistId}')" style="margin-right: 0.5rem;">
                    <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Detalii
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="revokeBundle('${b.specialistId}', '${escapeHtml(b.specialistName)}')">
                    <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                    RevocÄƒ
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    return d.toLocaleDateString('ro-RO', { year: 'numeric', month: 'short', day: 'numeric' });
  }

  // Toggle premium for bundle specialist
  window.toggleBundlePremium = async function(specialistId, isPremium) {
    try {
      const res = await fetch(`/api/logopedie/bundles/${specialistId}/premium`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ isPremium })
      });
      if (!res.ok) throw new Error('Failed to toggle premium');
      // Update local data
      const bundle = bundleData.find(b => b.specialistId === specialistId);
      if (bundle) bundle.isPremium = isPremium;
    } catch (err) {
      alert('Eroare la actualizarea statusului premium: ' + err.message);
      loadBundles(); // Reload to revert
    }
  };

  // View bundle detail
  window.viewBundleDetail = async function(specialistId) {
    const modal = document.getElementById('bundle-detail-modal');
    const content = document.getElementById('bundle-detail-content');
    
    modal.style.display = 'flex';
    content.innerHTML = `
      <div style="text-align: center; padding: 2rem;">
        <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 2rem; height: 2rem; animation: spin 1s linear infinite;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="muted">Se Ã®ncarcÄƒ detaliile...</p>
      </div>
    `;

    try {
      const res = await fetch(`/api/logopedie/bundles/${specialistId}`, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load bundle detail');
      const detail = await res.json();
      
      content.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
          <h4 style="margin-bottom: 0.5rem;">${escapeHtml(detail.specialistName)}</h4>
          <p class="muted">${escapeHtml(detail.specialistEmail)}</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="padding: 1rem; background: var(--bg-muted, #f3f4f6); border-radius: 6px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 600;">${detail.totalKeys}</div>
            <div class="muted">Chei Totale</div>
          </div>
          <div style="padding: 1rem; background: var(--bg-muted, #f3f4f6); border-radius: 6px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 600;">${detail.usedKeys}</div>
            <div class="muted">Chei Folosite</div>
          </div>
          <div style="padding: 1rem; background: var(--bg-muted, #f3f4f6); border-radius: 6px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 600;">${detail.totalKeys - detail.usedKeys}</div>
            <div class="muted">Chei Disponibile</div>
          </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <p><strong>Alocat la:</strong> ${formatDate(detail.assignedAt)}</p>
          <p><strong>Alocat de:</strong> ${escapeHtml(detail.assignedByName)}</p>
          ${detail.notes ? `<p><strong>Note:</strong> ${escapeHtml(detail.notes)}</p>` : ''}
          <p><strong>Status Premium:</strong> ${detail.isPremium ? '<span style="color: var(--success, #22c55e);">Da</span>' : 'Nu'}</p>
        </div>
        
        <h4 style="margin-bottom: 0.75rem;">Chei de LicenÈ›Äƒ</h4>
        <div style="max-height: 300px; overflow-y: auto;">
          <table class="data-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
              <tr style="background: var(--bg-muted, #f3f4f6);">
                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border);">Cheie</th>
                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border);">Profil</th>
                <th style="padding: 0.5rem; text-align: center; border-bottom: 1px solid var(--border);">Status</th>
                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border);">Activat la</th>
              </tr>
            </thead>
            <tbody>
              ${detail.keys.map(k => `
                <tr style="border-bottom: 1px solid var(--border);">
                  <td style="padding: 0.5rem; font-family: monospace; font-size: 0.75rem;">${k.keyUuid}</td>
                  <td style="padding: 0.5rem;">${k.profileName || '-'}</td>
                  <td style="padding: 0.5rem; text-align: center;">
                    ${k.profileName 
                      ? '<span style="color: var(--success, #22c55e);">Folosit</span>' 
                      : '<span style="color: var(--text-muted);">Disponibil</span>'
                    }
                  </td>
                  <td style="padding: 0.5rem;">${k.activatedAt ? formatDate(k.activatedAt) : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    } catch (err) {
      content.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--danger, #dc2626);">
          <p>Eroare la Ã®ncÄƒrcarea detaliilor: ${err.message}</p>
        </div>
      `;
    }
  };

  window.closeBundleDetailModal = function() {
    document.getElementById('bundle-detail-modal').style.display = 'none';
  };

  // Revoke bundle
  window.revokeBundle = async function(specialistId, specialistName) {
    if (!confirm(`EÈ™ti sigur cÄƒ vrei sÄƒ revoci bundle-ul pentru ${specialistName}?\n\nAceastÄƒ acÈ›iune va È™terge toate cheile È™i profilurile asociate!`)) {
      return;
    }

    try {
      const res = await fetch(`/api/logopedie/bundles/${specialistId}`, {
        method: 'DELETE',
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error('Failed to revoke bundle');
      loadBundles();
    } catch (err) {
      alert('Eroare la revocarea bundle-ului: ' + err.message);
    }
  };

  // Assign bundle modal
  window.openAssignBundleModal = function() {
    document.getElementById('assign-bundle-modal').style.display = 'flex';
    document.getElementById('assign-bundle-form').reset();
    document.getElementById('bundle-specialist-id').value = '';
    document.getElementById('selected-specialist').style.display = 'none';
    document.getElementById('specialist-search-results').style.display = 'none';
    document.getElementById('assign-bundle-btn').disabled = true;
    document.getElementById('assign-bundle-result').style.display = 'none';
  };

  window.closeAssignBundleModal = function() {
    document.getElementById('assign-bundle-modal').style.display = 'none';
  };

  window.clearSelectedSpecialist = function() {
    document.getElementById('bundle-specialist-id').value = '';
    document.getElementById('selected-specialist').style.display = 'none';
    document.getElementById('bundle-specialist-search').value = '';
    document.getElementById('assign-bundle-btn').disabled = true;
  };

  // Specialist search
  const specialistSearchInput = document.getElementById('bundle-specialist-search');
  const searchResultsContainer = document.getElementById('specialist-search-results');

  specialistSearchInput?.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const query = specialistSearchInput.value.trim();
    
    if (query.length < 2) {
      searchResultsContainer.style.display = 'none';
      return;
    }

    searchTimeout = setTimeout(async () => {
      try {
        // Search for SPECIALIST users only (not SPECIALIST_BUNDLE)
        const res = await fetch(`/api/logopedie/specialists/search?q=${encodeURIComponent(query)}`, {
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Search failed');
        const results = await res.json();
        
        if (results.length === 0) {
          searchResultsContainer.innerHTML = '<div style="padding: 0.75rem; color: var(--text-muted);">Niciun specialist gÄƒsit</div>';
        } else {
          searchResultsContainer.innerHTML = results.map(s => `
            <div class="search-result-item" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border);" 
                 onclick="selectSpecialist('${s.id}', '${escapeHtml(s.name)}', '${escapeHtml(s.email)}')">
              <div style="font-weight: 500;">${escapeHtml(s.name)}</div>
              <div style="font-size: 0.875rem; color: var(--text-muted);">${escapeHtml(s.email)}</div>
            </div>
          `).join('');
        }
        searchResultsContainer.style.display = 'block';
      } catch (err) {
        searchResultsContainer.innerHTML = `<div style="padding: 0.75rem; color: var(--danger);">Eroare: ${err.message}</div>`;
        searchResultsContainer.style.display = 'block';
      }
    }, 300);
  });

  window.selectSpecialist = function(id, name, email) {
    document.getElementById('bundle-specialist-id').value = id;
    document.getElementById('selected-specialist-name').textContent = `${name} (${email})`;
    document.getElementById('selected-specialist').style.display = 'block';
    document.getElementById('specialist-search-results').style.display = 'none';
    document.getElementById('bundle-specialist-search').value = '';
    document.getElementById('assign-bundle-btn').disabled = false;
  };

  // Assign bundle form submission
  document.getElementById('assign-bundle-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const specialistId = document.getElementById('bundle-specialist-id').value;
    const keyCount = parseInt(document.getElementById('bundle-key-count').value);
    const notes = document.getElementById('bundle-notes').value;
    const resultDiv = document.getElementById('assign-bundle-result');
    const btn = document.getElementById('assign-bundle-btn');

    if (!specialistId) {
      alert('Te rog selecteazÄƒ un specialist.');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Se salveazÄƒ...';
    resultDiv.style.display = 'none';

    try {
      const res = await fetch('/api/logopedie/bundles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ specialistId, keyCount, notes })
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || 'Failed to assign bundle');
      }

      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--success-bg, #d4edda)';
      resultDiv.style.color = 'var(--success-text, #155724)';
      resultDiv.innerHTML = 'Bundle adÄƒugat cu succes!';
      
      setTimeout(() => {
        closeAssignBundleModal();
        loadBundles();
      }, 1500);
    } catch (err) {
      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
      resultDiv.style.color = 'var(--danger-text, #721c24)';
      resultDiv.innerHTML = `Eroare: ${err.message}`;
    } finally {
      btn.disabled = false;
      btn.textContent = 'AdaugÄƒ Bundle';
    }
  });

  // Close modals on outside click
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // Make functions global
  window.loadBundles = loadBundles;

  // Notification form handling
  const targetSelect = document.getElementById('notif-target');
  const bodyTextarea = document.getElementById('notif-body');
  const charCount = document.getElementById('char-count');
  const form = document.getElementById('notification-form');
  const resultDiv = document.getElementById('notification-result');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const sendBtn = document.getElementById('send-btn');

  // Character counter
  bodyTextarea.addEventListener('input', () => {
    charCount.textContent = bodyTextarea.value.length;
  });

  // Load and handle require_active_for_login setting (admin only)
  const isAdmin = <%- JSON.stringify(user && user.userRole === 'ADMIN') %>;
  
  if (isAdmin) {
  const requireActiveToggle = document.getElementById('require-active-toggle');
  const toggleLabel = document.getElementById('toggle-label');
  const toggleDescription = document.getElementById('toggle-description');
  const settingStatus = document.getElementById('setting-status');

  // Load current setting
  async function loadRequireActiveSetting() {
    try {
      const res = await fetch('/api/logopedie/require-active-for-login', {
        credentials: 'same-origin'
      });
      if (res.ok) {
        const data = await res.json();
        requireActiveToggle.checked = data.requireActiveForLogin || false;
        updateToggleLabel();
      }
    } catch (err) {
      console.error('Error loading setting:', err);
    }
  }

  function updateToggleLabel() {
    if (requireActiveToggle.checked) {
      toggleLabel.textContent = 'Permite autentificare doar pentru conturi ACTIVE';
      toggleDescription.textContent = 'CÃ¢nd este activatÄƒ, doar conturile cu status ACTIVE pot sÄƒ se autentifice Ã®n aplicaÈ›ia mobilÄƒ.';
    } else {
      toggleLabel.textContent = 'Permite autentificare pentru toate conturile';
      toggleDescription.textContent = 'CÃ¢nd este dezactivatÄƒ, toate conturile (ACTIVE, PENDING, INACTIVE) pot sÄƒ se autentifice Ã®n aplicaÈ›ia mobilÄƒ.';
    }
  }

  // Save setting on toggle
  requireActiveToggle.addEventListener('change', async () => {
    const isChecked = requireActiveToggle.checked;
    settingStatus.style.display = 'block';
        settingStatus.style.background = 'var(--info-bg, #d1ecf1)';
        settingStatus.style.color = 'var(--info-text, #0c5460)';
        settingStatus.style.padding = '0.5rem';
        settingStatus.style.borderRadius = '4px';
        settingStatus.innerHTML = '<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem; animation: spin 1s linear infinite;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Se salveazÄƒ...';
    requireActiveToggle.disabled = true;

    try {
      const res = await fetch('/api/logopedie/require-active-for-login', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ requireActiveForLogin: isChecked })
      });

      if (res.ok) {
        settingStatus.style.background = 'var(--success-bg, #d4edda)';
        settingStatus.style.color = 'var(--success-text, #155724)';
        settingStatus.innerHTML = '<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Setare salvatÄƒ cu succes!';
        updateToggleLabel();
        setTimeout(() => {
          settingStatus.style.display = 'none';
        }, 3000);
      } else {
        const data = await res.json();
        settingStatus.style.background = 'var(--danger-bg, #f8d7da)';
        settingStatus.style.color = 'var(--danger-text, #721c24)';
        settingStatus.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Eroare: ${data.message || 'Nu s-a putut salva setarea'}`;
        requireActiveToggle.checked = !isChecked; // Revert on error
      }
    } catch (err) {
      settingStatus.style.background = 'var(--danger-bg, #f8d7da)';
      settingStatus.style.color = 'var(--danger-text, #721c24)';
      settingStatus.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Eroare de conexiune: ${err.message}`;
      requireActiveToggle.checked = !isChecked; // Revert on error
    } finally {
      requireActiveToggle.disabled = false;
    }
  });

  // Load setting on page load
  loadRequireActiveSetting();
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const target = formData.get('target');
    const title = formData.get('title');
    const body = formData.get('body');
    
    const payload = { title, body };
    
    // Map target values to API payload
    switch (target) {
      case 'all':
        payload.target = 'all';
        break;
      case 'user_normal':
        payload.target = 'role';
        payload.role = 'USER';
        payload.isPremium = false;
        break;
      case 'user_premium':
        payload.target = 'role';
        payload.role = 'USER';
        payload.isPremium = true;
        break;
      case 'specialist_all':
        payload.target = 'role';
        payload.role = 'SPECIALIST';
        break;
      case 'specialist_normal':
        payload.target = 'role';
        payload.role = 'SPECIALIST';
        payload.isPremium = false;
        break;
      case 'specialist_premium':
        payload.target = 'role';
        payload.role = 'SPECIALIST';
        payload.isPremium = true;
        break;
      default:
        payload.target = target;
    }

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'flex';
    sendBtn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const response = await fetch('/api/logopedie/notifications/targeted', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      
      resultDiv.style.display = 'block';
      if (response.ok && data.success) {
        resultDiv.style.background = 'var(--success-bg, #d4edda)';
        resultDiv.style.color = 'var(--success-text, #155724)';
        resultDiv.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>${data.message}`;
        form.reset();
        charCount.textContent = '0';
      } else {
        resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
        resultDiv.style.color = 'var(--danger-text, #721c24)';
        resultDiv.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>${data.message || 'Eroare la trimitere'}`;
      }
    } catch (err) {
      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
      resultDiv.style.color = 'var(--danger-text, #721c24)';
      resultDiv.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Eroare de conexiune: ${err.message}`;
    } finally {
      btnText.style.display = 'flex';
      btnLoading.style.display = 'none';
      sendBtn.disabled = false;
    }
  });
});
</script>

<%- include('partials/footer') %>
