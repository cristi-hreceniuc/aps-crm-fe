<%- include('partials/head', { title: 'Aplica»õie LogopedicƒÉ' }) %>
<div class="app">
  <%- include('partials/sidenav', { path, isLogged, user }) %>

  <main class="content-shell">
    <header class="content-header">
      <div>
        <h1>Aplica»õie LogopedicƒÉ</h1>
        <small class="muted">Administrare</small>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="grid-users">Utilizatori</button>
      <button class="tab-btn" data-tab="grid-notifications">NotificƒÉri</button>
    </div>

    <!-- Grid 1: Utilizatori -->
    <section id="grid-users" class="tab-pane active">
      <%- include('partials/datagrid', {
        gridId: 'log-users',
        title: 'Utilizatori',
        subtitle: 'Gestionare conturi logopedie',
        searchPlaceholder: 'CautƒÉ dupƒÉ nume, email sau telefon‚Ä¶',
        endpoint: '/api/logopedie/users',         // list/search unificat
        endpointSearch: '/api/logopedie/users',   // datagrid trimite ?q=
        pageSize: 10,
        api: { pageParam:'page', sizeParam:'size', sortParam:'sort', sortValue:'{key},{dir}', pageBase:0, searchParam:'q' },
        response: { items:'content', page:'number', size:'size', total:'totalElements' },
        columns: [
          { key:'firstName',        label:'Nume',          sortable:true, sortKey:'firstName' },
          { key:'lastName',      label:'Prenume',        sortable:true, sortKey:'lastName' },
          { key:'email',     label:'Email',       sortable:true, sortKey:'email', clamp:1 },
          { key:'createdAt', label:'Creat la',    sortable:true, sortKey:'createdAt', type:'date' },
          { key:'updatedAt', label:'Actualizat la',    sortable:true, sortKey:'updatedAt', type:'date' },
          { key:'gender', label:'Gen',    sortable:true, sortKey:'gender' },
          { key:'status',    label:'Status',      sortable:true, sortKey:'status' },
          { key:'role',    label:'Rol',      sortable:true, sortKey:'role' },
          { key:'isPremium', label:'Premium',     sortable:true, sortKey:'isPremium', type:'bool' },
          { key:'actions',   label:'Ac»õiuni',     type:'actions' }
        ],
        autosize: { minPx: 90, maxPx: 320 }
      }) %>
    </section>

    <!-- Tab 2: NotificƒÉri -->
    <section id="grid-notifications" class="tab-pane">
      <div class="card" style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
        <h2 style="margin-bottom: 0.5rem;">üì¢ Trimite Notificare</h2>
        <p class="muted" style="margin-bottom: 1.5rem;">Trimite notificƒÉri push cƒÉtre utilizatorii aplica»õiei mobile</p>
        
        <form id="notification-form">
          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="notif-target" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Destinatari</label>
            <select id="notif-target" name="target" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
              <option value="all">To»õi utilizatorii</option>
              <option value="premium">Doar Premium</option>
              <option value="non_premium">Doar Non-Premium</option>
              <option value="role">DupƒÉ Rol</option>
            </select>
          </div>

          <div id="role-options" style="display: none; margin-bottom: 1rem;">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="notif-role" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rol</label>
              <select id="notif-role" name="role" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
                <option value="USER">Utilizator (USER)</option>
                <option value="SPECIALIST">Specialist (SPECIALIST)</option>
                <option value="ADMIN">Administrator (ADMIN)</option>
                <option value="VOLUNTEER">Voluntar (VOLUNTEER)</option>
              </select>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="filter-premium" name="filterPremium">
                <span>FiltreazƒÉ »ôi dupƒÉ status premium</span>
              </label>
            </div>
            <div id="premium-filter" style="display: none; margin-top: 0.5rem; margin-left: 1.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="isPremium" value="true"> Premium
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.25rem;">
                <input type="radio" name="isPremium" value="false" checked> Non-Premium
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="notif-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Titlu</label>
            <input type="text" id="notif-title" name="title" required maxlength="100"
                   placeholder="Ex: NoutƒÉ»õi √Æn aplica»õie! üéâ"
                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="notif-body" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mesaj</label>
            <textarea id="notif-body" name="body" required rows="4" maxlength="500"
                      placeholder="Mesajul notificƒÉrii..."
                      style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
            <small class="muted" style="display: block; margin-top: 0.25rem;"><span id="char-count">0</span>/500 caractere</small>
          </div>

          <div id="notification-result" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>

          <button type="submit" id="send-btn" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
            <span id="btn-text">üì§ Trimite Notificare</span>
            <span id="btn-loading" style="display: none;">‚è≥ Se trimite...</span>
          </button>
        </form>
      </div>
    </section>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tab switching (same pattern as cauze.ejs)
  const tabs = document.querySelectorAll('.tab-btn');
  const panes = document.querySelectorAll('.tab-pane');

  const savedTab = localStorage.getItem('logopedie-active-tab') || 'grid-users';

  function activateTab(tabId) {
    tabs.forEach(x => x.classList.remove('active'));
    panes.forEach(x => x.classList.remove('active'));

    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    const pane = document.getElementById(tabId);

    if (btn && pane) {
      btn.classList.add('active');
      pane.classList.add('active');
      localStorage.setItem('logopedie-active-tab', tabId);
      window.dispatchEvent(new Event('resize'));
    }
  }

  activateTab(savedTab);

  tabs.forEach(b => {
    b.addEventListener('click', () => {
      activateTab(b.dataset.tab);
    });
  });

  // Notification form handling
  const targetSelect = document.getElementById('notif-target');
  const roleOptions = document.getElementById('role-options');
  const filterPremiumCheckbox = document.getElementById('filter-premium');
  const premiumFilter = document.getElementById('premium-filter');
  const bodyTextarea = document.getElementById('notif-body');
  const charCount = document.getElementById('char-count');
  const form = document.getElementById('notification-form');
  const resultDiv = document.getElementById('notification-result');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const sendBtn = document.getElementById('send-btn');

  // Show/hide role options based on target selection
  targetSelect.addEventListener('change', () => {
    roleOptions.style.display = targetSelect.value === 'role' ? 'block' : 'none';
  });

  // Show/hide premium filter
  filterPremiumCheckbox.addEventListener('change', () => {
    premiumFilter.style.display = filterPremiumCheckbox.checked ? 'block' : 'none';
  });

  // Character counter
  bodyTextarea.addEventListener('input', () => {
    charCount.textContent = bodyTextarea.value.length;
  });

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const target = formData.get('target');
    const title = formData.get('title');
    const body = formData.get('body');
    
    const payload = { title, body, target };
    
    if (target === 'role') {
      payload.role = formData.get('role');
      if (filterPremiumCheckbox.checked) {
        payload.isPremium = formData.get('isPremium') === 'true';
      }
    }

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    sendBtn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const response = await fetch('/api/logopedie/notifications/targeted', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      
      resultDiv.style.display = 'block';
      if (response.ok && data.success) {
        resultDiv.style.background = 'var(--success-bg, #d4edda)';
        resultDiv.style.color = 'var(--success-text, #155724)';
        resultDiv.innerHTML = `‚úÖ ${data.message}`;
        form.reset();
        charCount.textContent = '0';
        roleOptions.style.display = 'none';
        premiumFilter.style.display = 'none';
      } else {
        resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
        resultDiv.style.color = 'var(--danger-text, #721c24)';
        resultDiv.innerHTML = `‚ùå ${data.message || 'Eroare la trimitere'}`;
      }
    } catch (err) {
      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
      resultDiv.style.color = 'var(--danger-text, #721c24)';
      resultDiv.innerHTML = `‚ùå Eroare de conexiune: ${err.message}`;
    } finally {
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      sendBtn.disabled = false;
    }
  });
});
</script>

<%- include('partials/footer') %>
