<%- include('partials/head', { title: 'Aplica»õie LogopedicƒÉ' }) %>
<div class="app">
  <%- include('partials/sidenav', { path, isLogged, user }) %>

  <main class="content-shell">
    <header class="content-header">
      <div>
        <h1>Aplica»õie LogopedicƒÉ</h1>
        <small class="muted">Administrare</small>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="grid-users">Utilizatori</button>
      <button class="tab-btn" data-tab="grid-notifications">NotificƒÉri</button>
    </div>

    <!-- Grid 1: Utilizatori -->
    <section id="grid-users" class="tab-pane active">
      <%- include('partials/datagrid', {
        gridId: 'log-users',
        title: 'Utilizatori',
        subtitle: 'Gestionare conturi logopedie',
        searchPlaceholder: 'CautƒÉ dupƒÉ nume, email sau telefon‚Ä¶',
        endpoint: '/api/logopedie/users',         // list/search unificat
        endpointSearch: '/api/logopedie/users',   // datagrid trimite ?q=
        pageSize: 10,
        api: { pageParam:'page', sizeParam:'size', sortParam:'sort', sortValue:'{key},{dir}', pageBase:0, searchParam:'q' },
        response: { items:'content', page:'number', size:'size', total:'totalElements' },
        columns: [
          { key:'firstName',        label:'Nume',          sortable:true, sortKey:'firstName' },
          { key:'lastName',      label:'Prenume',        sortable:true, sortKey:'lastName' },
          { key:'email',     label:'Email',       sortable:true, sortKey:'email', clamp:1 },
          { key:'createdAt', label:'Creat la',    sortable:true, sortKey:'createdAt', type:'date' },
          { key:'updatedAt', label:'Actualizat la',    sortable:true, sortKey:'updatedAt', type:'date' },
          { key:'gender', label:'Gen',    sortable:true, sortKey:'gender' },
          { key:'status',    label:'Status',      sortable:true, sortKey:'status' },
          { key:'role',    label:'Rol',      sortable:true, sortKey:'role' },
          { key:'isPremium', label:'Premium',     sortable:true, sortKey:'isPremium', type:'bool' },
          { key:'actions',   label:'Ac»õiuni',     type:'actions' }
        ],
        autosize: { minPx: 90, maxPx: 320 }
      }) %>

      <!-- Settings Card (Admin Only) -->
      <% if (user && user.userRole === 'ADMIN') { %>
      <div class="card" style="margin-top: 2rem;">
        <h2 style="margin-bottom: 0.5rem;">SetƒÉri Autentificare</h2>
        <p class="muted" style="margin-bottom: 1rem;">ControleazƒÉ restric»õiile de autentificare pentru aplica»õia mobilƒÉ</p>
        
        <label class="auth-toggle" style="margin-top: 12px; display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
          <input type="checkbox" id="require-active-toggle">
          <span class="slider"></span>
          <span id="toggle-label">Permite autentificare doar pentru conturi ACTIVE</span>
        </label>
        <small class="muted" style="display: block; margin-top: 0.5rem; margin-left: 3rem;">
          <span id="toggle-description">C√¢nd este activatƒÉ, doar conturile cu status ACTIVE pot sƒÉ se autentifice √Æn aplica»õia mobilƒÉ.</span>
        </small>
        <div id="setting-status" style="margin-top: 0.75rem; margin-left: 3rem; display: none;"></div>
      </div>
      <% } %>
    </section>

    <!-- Tab 2: NotificƒÉri -->
    <section id="grid-notifications" class="tab-pane">
      <div class="card" style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
        <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.5rem; height: 1.5rem; color: var(--primary, #dc2626);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 110-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 01-1.44-4.282m3.102.069a18.03 18.03 0 01-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 018.835 2.535M10.34 6.66a23.847 23.847 0 008.835-2.535m0 0A23.74 23.74 0 0018.795 3m.38 1.125a23.91 23.91 0 011.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 001.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a23.91 23.91 0 010 3.46" />
          </svg>
          Trimite Notificare
        </h2>
        <p class="muted" style="margin-bottom: 1.5rem;">Trimite notificƒÉri push cƒÉtre utilizatorii aplica»õiei mobile</p>
        
        <form id="notification-form">
          <div class="form-group" style="margin-bottom: 1rem; position: relative;">
            <label for="notif-target" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Destinatari</label>
            <select id="notif-target" name="target" required style="width: 100%; padding: 0.75rem; padding-right: 2.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; appearance: none; background-color: var(--bg, #fff);">
              <option value="all">To»õi utilizatorii</option>
              <option value="user_normal">To»õi utilizatorii normali</option>
              <option value="user_premium">To»õi utilizatorii premium</option>
              <option value="specialist_all">To»õi speciali»ôtii</option>
              <option value="specialist_normal">To»õi speciali»ôtii normali</option>
              <option value="specialist_premium">To»õi speciali»ôtii premium</option>
            </select>
            <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; position: absolute; right: 0.75rem; top: 2.5rem; pointer-events: none; color: var(--text-muted, #6b7280);">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </div>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="notif-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Titlu</label>
            <input type="text" id="notif-title" name="title" required maxlength="100"
                   placeholder="Ex: NoutƒÉ»õi √Æn aplica»õie! üéâ"
                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="notif-body" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mesaj</label>
            <textarea id="notif-body" name="body" required rows="4" maxlength="500"
                      placeholder="Mesajul notificƒÉrii..."
                      style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
            <small class="muted" style="display: block; margin-top: 0.25rem;"><span id="char-count">0</span>/500 caractere</small>
          </div>

          <div id="notification-result" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>

          <button type="submit" id="send-btn" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <span id="btn-text" style="display: flex; align-items: center; gap: 0.5rem;">
              <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
              </svg>
              Trimite Notificare
            </span>
            <span id="btn-loading" style="display: none; align-items: center; gap: 0.5rem;">
              <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; animation: spin 1s linear infinite;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Se trimite...
            </span>
          </button>
        </form>
      </div>
    </section>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tab switching (same pattern as cauze.ejs)
  const tabs = document.querySelectorAll('.tab-btn');
  const panes = document.querySelectorAll('.tab-pane');

  const savedTab = localStorage.getItem('logopedie-active-tab') || 'grid-users';

  function activateTab(tabId) {
    tabs.forEach(x => x.classList.remove('active'));
    panes.forEach(x => x.classList.remove('active'));

    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    const pane = document.getElementById(tabId);

    if (btn && pane) {
      btn.classList.add('active');
      pane.classList.add('active');
      localStorage.setItem('logopedie-active-tab', tabId);
      window.dispatchEvent(new Event('resize'));
    }
  }

  activateTab(savedTab);

  tabs.forEach(b => {
    b.addEventListener('click', () => {
      activateTab(b.dataset.tab);
    });
  });

  // Notification form handling
  const targetSelect = document.getElementById('notif-target');
  const bodyTextarea = document.getElementById('notif-body');
  const charCount = document.getElementById('char-count');
  const form = document.getElementById('notification-form');
  const resultDiv = document.getElementById('notification-result');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const sendBtn = document.getElementById('send-btn');

  // Character counter
  bodyTextarea.addEventListener('input', () => {
    charCount.textContent = bodyTextarea.value.length;
  });

  // Load and handle require_active_for_login setting (admin only)
  <% if (user && user.userRole === 'ADMIN') { %>
  const requireActiveToggle = document.getElementById('require-active-toggle');
  const toggleLabel = document.getElementById('toggle-label');
  const toggleDescription = document.getElementById('toggle-description');
  const settingStatus = document.getElementById('setting-status');

  // Load current setting
  async function loadRequireActiveSetting() {
    try {
      const res = await fetch('/api/logopedie/require-active-for-login', {
        credentials: 'same-origin'
      });
      if (res.ok) {
        const data = await res.json();
        requireActiveToggle.checked = data.requireActiveForLogin || false;
        updateToggleLabel();
      }
    } catch (err) {
      console.error('Error loading setting:', err);
    }
  }

  function updateToggleLabel() {
    if (requireActiveToggle.checked) {
      toggleLabel.textContent = 'Permite autentificare doar pentru conturi ACTIVE';
      toggleDescription.textContent = 'C√¢nd este activatƒÉ, doar conturile cu status ACTIVE pot sƒÉ se autentifice √Æn aplica»õia mobilƒÉ.';
    } else {
      toggleLabel.textContent = 'Permite autentificare pentru toate conturile';
      toggleDescription.textContent = 'C√¢nd este dezactivatƒÉ, toate conturile (ACTIVE, PENDING, INACTIVE) pot sƒÉ se autentifice √Æn aplica»õia mobilƒÉ.';
    }
  }

  // Save setting on toggle
  requireActiveToggle.addEventListener('change', async () => {
    const isChecked = requireActiveToggle.checked;
    settingStatus.style.display = 'block';
        settingStatus.style.background = 'var(--info-bg, #d1ecf1)';
        settingStatus.style.color = 'var(--info-text, #0c5460)';
        settingStatus.style.padding = '0.5rem';
        settingStatus.style.borderRadius = '4px';
        settingStatus.innerHTML = '<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem; animation: spin 1s linear infinite;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Se salveazƒÉ...';
    requireActiveToggle.disabled = true;

    try {
      const res = await fetch('/api/logopedie/require-active-for-login', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ requireActiveForLogin: isChecked })
      });

      if (res.ok) {
        settingStatus.style.background = 'var(--success-bg, #d4edda)';
        settingStatus.style.color = 'var(--success-text, #155724)';
        settingStatus.innerHTML = '<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Setare salvatƒÉ cu succes!';
        updateToggleLabel();
        setTimeout(() => {
          settingStatus.style.display = 'none';
        }, 3000);
      } else {
        const data = await res.json();
        settingStatus.style.background = 'var(--danger-bg, #f8d7da)';
        settingStatus.style.color = 'var(--danger-text, #721c24)';
        settingStatus.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Eroare: ${data.message || 'Nu s-a putut salva setarea'}`;
        requireActiveToggle.checked = !isChecked; // Revert on error
      }
    } catch (err) {
      settingStatus.style.background = 'var(--danger-bg, #f8d7da)';
      settingStatus.style.color = 'var(--danger-text, #721c24)';
      settingStatus.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Eroare de conexiune: ${err.message}`;
      requireActiveToggle.checked = !isChecked; // Revert on error
    } finally {
      requireActiveToggle.disabled = false;
    }
  });

  // Load setting on page load
  loadRequireActiveSetting();
  <% } %>

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const target = formData.get('target');
    const title = formData.get('title');
    const body = formData.get('body');
    
    const payload = { title, body };
    
    // Map target values to API payload
    switch (target) {
      case 'all':
        payload.target = 'all';
        break;
      case 'user_normal':
        payload.target = 'role';
        payload.role = 'USER';
        payload.isPremium = false;
        break;
      case 'user_premium':
        payload.target = 'role';
        payload.role = 'USER';
        payload.isPremium = true;
        break;
      case 'specialist_all':
        payload.target = 'role';
        payload.role = 'SPECIALIST';
        break;
      case 'specialist_normal':
        payload.target = 'role';
        payload.role = 'SPECIALIST';
        payload.isPremium = false;
        break;
      case 'specialist_premium':
        payload.target = 'role';
        payload.role = 'SPECIALIST';
        payload.isPremium = true;
        break;
      default:
        payload.target = target;
    }

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'flex';
    sendBtn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const response = await fetch('/api/logopedie/notifications/targeted', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      
      resultDiv.style.display = 'block';
      if (response.ok && data.success) {
        resultDiv.style.background = 'var(--success-bg, #d4edda)';
        resultDiv.style.color = 'var(--success-text, #155724)';
        resultDiv.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>${data.message}`;
        form.reset();
        charCount.textContent = '0';
      } else {
        resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
        resultDiv.style.color = 'var(--danger-text, #721c24)';
        resultDiv.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>${data.message || 'Eroare la trimitere'}`;
      }
    } catch (err) {
      resultDiv.style.display = 'block';
      resultDiv.style.background = 'var(--danger-bg, #f8d7da)';
      resultDiv.style.color = 'var(--danger-text, #721c24)';
      resultDiv.innerHTML = `<svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Eroare de conexiune: ${err.message}`;
    } finally {
      btnText.style.display = 'flex';
      btnLoading.style.display = 'none';
      sendBtn.disabled = false;
    }
  });
});
</script>

<%- include('partials/footer') %>
