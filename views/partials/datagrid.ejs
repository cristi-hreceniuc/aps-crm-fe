<!-- views/partials/datagrid.ejs -->
<section class="card"
         data-grid
         data-grid-id="<%= (typeof gridId !== 'undefined' ? gridId : (typeof grid_id !== 'undefined' ? grid_id : '')) %>">

  <div class="dg-toolbar">
    <div class="dg-left">
      <h2 class="dg-title"><%= title %></h2>
      <% if (typeof subtitle !== 'undefined' && subtitle) { %>
        <div class="muted"><%= subtitle %></div>
      <% } %>
    </div>
    <div class="dg-right">
      <input class="dg-search"
             type="search"
             inputmode="search"
             autocomplete="off"
             spellcheck="false"
             placeholder="<%= (typeof searchPlaceholder !== 'undefined' && searchPlaceholder) ? searchPlaceholder : 'Caută…' %>"
             aria-label="Căutare" />
    </div>
  </div>

  <% if (typeof selectable !== 'undefined' && selectable) { %>
    <div class="dg-select-all-bar">
      <button type="button"
              class="btn-mini outline dg-select-all-btn"
              title="Selectează toate înregistrările din tabel"
              aria-live="polite">
        <span class="dg-select-all-label">Selectează tot:</span>
        <span class="dg-select-count" aria-live="polite">0</span>
      </button>
      <span class="dg-select-all-info muted">
        Folosește această opțiune pentru a genera XML cu toate înregistrările.
      </span>
    </div>
  <% } %>

  <div class="dg-scroll">
    <table class="dg-table">
      <colgroup>
        <% if (typeof selectable !== 'undefined' && selectable) { %>
          <col class="dg-col dg-col-select">
        <% } %>
        <% (columns || []).forEach(function(c){ %>
          <col class="dg-col dg-col-<%= c.key %>">
        <% }) %>
      </colgroup>

      <thead>
        <tr>
          <% if (typeof selectable !== 'undefined' && selectable) { %>
            <th class="col-select">
              <label class="dg-check" title="Selectează toate">
                <input type="checkbox" class="dg-check-all">
                <span class="box"></span>
                <span class="vh">Selectează toate</span>
              </label>
            </th>
          <% } %>

          <% (columns || []).forEach(function(c){ %>
            <th class="col-<%= c.key %>" data-key="<%= c.key %>" <% if (c.sortable) { %> data-sortable="true" <% } %>>
              <div class="th-inner">
                <span class="th-label"><%= c.label %></span>
                <% if (c.sortable) { %>
                  <button class="dg-sort" title="Sortează" aria-hidden="true">
                    <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9l-4.5 4.5-4.5-4.5L9.75 9" />
                    </svg>
                  </button>
                <% } %>
              </div>
            </th>
          <% }) %>
        </tr>
      </thead>

      <tbody class="dg-body"><!-- rows from JS --></tbody>
    </table>
  </div>

<div class="dg-footer">
  <% if (typeof selectable !== 'undefined' && selectable) { %>
    <div class="dg-bulk">
      <input type="date" class="dg-bulk-date" aria-label="Data borderou">
      <button type="button" class="btn-mini outline dg-bulk-btn" disabled>Generează XML</button>
    </div>
  <% } else { %>
    <div class="dg-spacer"></div>
  <% } %>

  <div class="dg-pager">
    <button type="button" class="btn-mini outline dg-prev">
      <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
      </svg>
      Înapoi
    </button>
    <span class="dg-pages">—</span>
    <button type="button" class="btn-mini outline dg-next">
      Înainte
      <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
      </svg>
    </button>
  </div>

  <div class="dg-spacer"></div>
  
</div>


  <!-- Config JSON -->
  <script type="application/json" class="dg-config">
    <%- JSON.stringify({
      gridId:   (typeof gridId   !== 'undefined' ? gridId   : (typeof grid_id !== 'undefined' ? grid_id : '')),
      endpoint: (typeof endpoint !== 'undefined' ? endpoint : ''),
      endpointSearch: (typeof endpointSearch !== 'undefined' ? endpointSearch : null),
      pageSize: (typeof pageSize !== 'undefined' ? pageSize : 10),
      columns:  (typeof columns  !== 'undefined' ? columns  : []),
      api:      (typeof api      !== 'undefined' ? api      : {}),
      response: (typeof response !== 'undefined' ? response : {}),
      auth:     (typeof auth     !== 'undefined' ? auth     : null),
      selectable: !!(typeof selectable !== 'undefined' && selectable)
    }) %>
  </script>
  
  <!-- MOBILE GAP FIX SCRIPT -->
  <script>
    (function() {
      if (window.innerWidth <= 1024) {
        function forceRemoveGap() {
          const grids = document.querySelectorAll('[data-grid]');
          grids.forEach(grid => {
            const scroll = grid.querySelector('.dg-scroll');
            const toolbar = grid.querySelector('.dg-toolbar');
            const table = grid.querySelector('.dg-table');
            const tbody = table ? table.querySelector('tbody') : null;
            const thead = table ? table.querySelector('thead') : null;
            
            // STEP 1: Completely reset .dg-scroll
            if (scroll) {
              scroll.style.cssText = `
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                background: none !important;
                box-shadow: none !important;
                line-height: 0 !important;
                font-size: 0 !important;
                height: auto !important;
                min-height: 0 !important;
                overflow: visible !important;
              `;
            }
            
            // STEP 2: Reset toolbar bottom spacing
            if (toolbar) {
              toolbar.style.marginBottom = '0';
              toolbar.style.paddingBottom = '12px';
            }
            
            // STEP 3: Reset table
            if (table) {
              table.style.margin = '0';
              table.style.padding = '0';
            }
            
            // STEP 4: Reset tbody
            if (tbody) {
              tbody.style.margin = '0';
              tbody.style.padding = '0';
            }
            
            // STEP 5: Hide thead completely
            if (thead) {
              thead.style.display = 'none';
              thead.style.height = '0';
              thead.style.margin = '0';
              thead.style.padding = '0';
              thead.style.visibility = 'hidden';
              thead.style.position = 'absolute';
            }
          });
        }
        
        // Run immediately and after load
        forceRemoveGap();
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', forceRemoveGap);
        }
        window.addEventListener('load', forceRemoveGap);
        
        // Run again after delays to catch dynamic content
        setTimeout(forceRemoveGap, 50);
        setTimeout(forceRemoveGap, 200);
        setTimeout(forceRemoveGap, 500);
        setTimeout(forceRemoveGap, 1000);
        
        // Watch for DOM changes
        if (window.MutationObserver) {
          const observer = new MutationObserver(function(mutations) {
            let shouldUpdate = false;
            mutations.forEach(function(mutation) {
              if (mutation.addedNodes.length > 0) {
                shouldUpdate = true;
              }
            });
            if (shouldUpdate) {
              forceRemoveGap();
            }
          });
          
          document.querySelectorAll('[data-grid]').forEach(grid => {
            observer.observe(grid, { 
              childList: true, 
              subtree: true 
            });
          });
        }
      }
    })();
  </script>
</section>
