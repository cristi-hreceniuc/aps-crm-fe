<%- include('partials/head', { title: 'Rapoarte' }) %>

<div class="app">
  <%- include('partials/sidenav', { path, isLogged, user }) %>

  <main class="content-shell">
    <header class="content-header">
      <h1>Rapoarte</h1>
      <small class="muted">Exportă date din sistem</small>
    </header>

    <div class="card" style="max-width:500px;">
      <form id="export-form" method="GET" action="/api/reports/export">
        <label for="dataset">Selectează tabel:</label>
        <select id="dataset" name="dataset" required>
          <option value="">— alege —</option>
          <option value="voluntari">Voluntari</option>
          <option value="d177">Declarația 177</option>
          <option value="sponsorizare">Contract sponsorizare</option>
          <option value="f230">Formulare 230</option>
          <option value="iban">IBAN Beneficiari</option>
          <option value="cause">Cauze</option>
        </select>

        <button id="exportBtn" type="submit" class="btn-primary" style="margin-top:14px;">
          <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width: 1.125rem; height: 1.125rem; margin-right: 0.5rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
          </svg>
          Exportă date
        </button>
      </form>
    </div>
  </main>
</div>

<script>
document.getElementById('exportBtn').addEventListener('click', async () => {
  const dataset = document.getElementById('datasetSelect').value; // dropdown-ul tău
  const res = await fetch(`/api/reports/export?dataset=${dataset}`);
  const blob = await res.blob();

  // creează link temporar
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${dataset}.xlsx`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  window.URL.revokeObjectURL(url);
});
</script>

<%- include('partials/footer') %>
