<%- include('partials/head', { title: 'Înregistrare' }) %>

<div class="app">
  <%- include('partials/sidenav', { path, isLogged, user }) %>
  <main class="content-shell">
    <header class="content-header">
      <h1>Înregistrare</h1>
      <small class="muted">Creează un cont nou pentru CRM</small>
    </header>

    <section class="auth-card">
      <% if (message) { %>
        <div class="alert alert-success"><%= message %></div>
      <% } %>
      <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
      <% } %>

      <form id="regForm" class="form" novalidate>
        <div class="grid two">
          <div>
            <label for="regFirst">Prenume</label>
            <input id="regFirst" name="firstName" type="text" required placeholder="Ionut" />
          </div>
          <div>
            <label for="regLast">Nume</label>
            <input id="regLast" name="lastName" type="text" required placeholder="Popescu" />
          </div>
        </div>

        <label for="regGender">Gen</label>
        <select id="regGender" name="gender" required>
          <option value="" selected disabled>— Alege —</option>
          <option value="MALE">Bărbat</option>
          <option value="FEMALE">Femeie</option>
        </select>

        <label for="regEmail">Email</label>
        <input id="regEmail" name="email" type="email" required placeholder="you@example.com" />

        <label for="regPass">Parolă</label>
        <input id="regPass" name="password" type="password" required minlength="8" placeholder="Min. 8 caractere" />

        <button class="btn btn-outline no-fill" type="submit">Creează cont</button>
      </form>
    </section>
  </main>
</div>

<%- include('partials/footer') %>

<script>
document.getElementById('regForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const firstName = document.getElementById('regFirst').value.trim();
  const lastName  = document.getElementById('regLast').value.trim();
  const gender    = document.getElementById('regGender').value;
  const email     = document.getElementById('regEmail').value.trim();
  const password  = document.getElementById('regPass').value;

  // Client-side validation with specific error messages
  const errors = [];
  if (!firstName) errors.push('Prenumele este obligatoriu');
  if (!lastName) errors.push('Numele este obligatoriu');
  if (!gender) errors.push('Genul este obligatoriu');
  if (!email) errors.push('Email-ul este obligatoriu');
  else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) errors.push('Email-ul nu este valid');
  if (!password) errors.push('Parola este obligatorie');
  else if (password.length < 8) errors.push('Parola trebuie să aibă cel puțin 8 caractere');

  if (errors.length > 0) {
    // Show errors in the alert box instead of browser alert
    const alertBox = document.querySelector('.alert-danger') || document.createElement('div');
    alertBox.className = 'alert alert-danger';
    alertBox.textContent = errors.join('. ') + '.';
    if (!document.querySelector('.alert-danger')) {
      const form = document.getElementById('regForm');
      form.parentNode.insertBefore(alertBox, form);
    }
    return;
  }

  try {
    const res = await fetch('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ firstName, lastName, gender, email, password })
    });

    const html = await res.text();
    document.open(); document.write(html); document.close();
  } catch {
    alert('Eroare la înregistrare. Verifică conexiunea la internet.');
  }
});
</script>
